apiVersion: apps/v1
kind: Deployment
metadata:
  name: iiq
  labels:
    app: iiq
spec:
  replicas: 2
  selector:
    matchLabels:
      app: iiq
  template:
    metadata:
      labels:
        app: iiq
    spec:
      initContainers:
        - name: wait-for-identityiq-table
          image: mcr.microsoft.com/mssql-tools
          command:
            - /bin/sh
            - -c
            - |
              until /opt/mssql-tools/bin/sqlcmd -S db -U sa -P 'id3ntityIQ!-TQ8BaiOxKAL4v-4lCIxVx' -Q "SELECT 1 FROM identityiq"; do
                echo 'Waiting for identityiq table in MSSQL...'
                sleep 10
              done
          env:
            - name: MSSQL_SA_PASSWORD
              value: "id3ntityIQ!-TQ8BaiOxKAL4v-4lCIxVx"
      containers:
        - name: iiq
          image: 192.168.0.236:5000/sailpoint-docker:latest
          env:
            - name: DATABASE_TYPE
              value: "mssql"
            - name: MSSQL_HOST
              value: "db"
            - name: MSSQL_SA_USER
              value: "sa"
            - name: MSSQL_USER
              value: "identityiq"
            - name: MSSQL_PASS
              value: "id3ntityIQ!-TQ8BaiOxKAL4v-4lCIxVx"
            - name: MSSQL_SA_PASSWORD
              value: "id3ntityIQ!-TQ8BaiOxKAL4v-4lCIxVx"
            - name: MYSQL_HOST
              value: "db_mysql"
            - name: MYSQL_USER
              value: "identityiq"
            - name: MYSQL_PASSWORD
              value: "identityiq"
            - name: MYSQL_DATABASE
              value: "identityiq"
            - name: MYSQL_ROOT_PASSWORD
              value: "password"
            - name: CATALINA_OPTS
              value: "-Xmx2048M"