<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow created="1754252269539" explicitTransitions="true" id="0a2a018f9870150e8198719557e201e9" modified="1754643288251" name="Azure AD B2B Provisioning" significantModified="1754643288251" type="IdentityLifecycle">
  <Variable name="plan"/>
  <Variable name="identityRequestId"/>
  <Variable name="identityModel"/>
  <Variable name="identityName"/>
  <Variable initializer="string:true" name="transient"/>
  <Variable initializer="true" name="trace"/>
  <Variable initializer="true" name="foregroundProvisioning"/>
  <Variable name="EmailAddress">
    <Description>
      The Email Variable.
    </Description>
  </Variable>
  <Variable name="RedirectURL">
    <Description>
      The Redirect URL Variable.
    </Description>
  </Variable>
  <Variable name="DisplayName">
    <Description>
      The Display Name Variable.
    </Description>
  </Variable>
  <Variable name="UsageLocation">
    <Description>
      The Usage Location Variable.
    </Description>
  </Variable>
  <Variable name="CustomInvitationMessage">
    <Description>
      The Custom Invitation Message Variable.
    </Description>
  </Variable>
  <Description>Provision Entra ID B2B Guest Account.</Description>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" id="0a2a037496e5102c8196e510a3a1019b" name="LCM Workflow Library"/>
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="28" posY="10">
    <Transition to="Azure AD B2B Request"/>
  </Step>
  <Step icon="Approval" name="Azure AD B2B Request" posX="135" posY="9">
    <Approval mode="serial" owner="ref:launcher" return="identityModel">
      <Arg name="workItemType" value="Form"/>
      <Arg name="workItemDescription" value="Azure AD B2B Account Request Form"/>
      <Arg name="workItemForm" value="Azure AD B2B Account Request Form"/>
      <Arg name="workItemFormBasePath" value="identityModel"/>
    </Approval>
    <Transition to="Set identity name"/>
  </Step>
  <Step name="Set identity name" posX="507" posY="6" resultVariable="identityModel">
    <Description>
      Set the identityName workflow variable based on the form input.
    </Description>
    <Script>
      <Source>
        String email = (String)identityModel.get("EmailAddress");
        String displayName = (String)identityModel.get("displayName");

        System.out.println("Setting the identityName from EmailAddress: " + email);
        System.out.println("Setting the identityName from DisplayName: " + displayName);


        if (email != null) {
        email = email.trim();
        }

        // If email is null or empty, we can't proceed without a valid identity name.
        // For the purpose of this workflow, we will treat an empty email as an error
        // or handle it by providing a default value. Here we set a default.
        if (email == null || email.isEmpty()) {
        email = "default@example.com";
        System.out.println("Email was null or empty, setting default: " + email);
        }

        
        firstName = displayName.split(" ")[0];
        lastName = displayName.split(" ")[1];
        identityModel.put("firstname", firstName);
        identityModel.put("lastname", lastName);
        identityModel.put("identityName", email);
        identityModel.put("name", email);
        identityModel.put("employeeType", "Contractor");
        workflow.put("identityName", email);

        return identityModel;
      </Source>
    </Script>
    <Transition to="Debug identityModel contents"/>
  </Step>
  <Step name="Debug identityModel contents">
    <Script>
      <Source>
        System.out.println("identityModel: " + identityModel.toString());
        return null;
      </Source>
    </Script>
    <Transition to="Build Provisioning Plan"/>
  </Step>
  <Step action="call:buildPlanFromIdentityModel" name="Build Provisioning Plan" posX="646" posY="6" resultVariable="plan">
    <Arg name="identityModel" value="ref:identityModel"/>
    <Description>
      Convert the registration request into a provisioning plan.
    </Description>
    <Transition to="Submit Registration Request"/>
  </Step>
  <Step icon="Task" name="Submit Registration Request" posX="646" posY="110">
    <Arg name="plan" value="ref:plan"/>
    <Arg name="flow" value="ref:flow"/>
    <Arg name="optimisticProvisioning" value="ref:optimisticProvisioning"/>
    <Arg name="foregroundProvisioning" value="ref:foregroundProvisioning"/>
    <Arg name="workItemPriority" value="ref:workItemPriority"/>
    <Arg name="source" value="ref:source"/>
    <Arg name="trace" value="ref:trace"/>
    <Arg name="fallbackApprover" value="ref:fallbackApprover"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Description>
      Call the LCM Provisioning workflow with the plan that was created.
    </Description>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" id="0a2a037496e5113d8196e5118bdd0036" name="LCM Provisioning"/>
    </WorkflowRef>
    <Transition to="end"/>
  </Step>
  <Step icon="Stop" name="end" posX="646" posY="217"/>
</Workflow>
